# Example GitLab CI configuration for FireRunner
# This demonstrates various use cases and tag formats

stages:
  - build
  - test
  - deploy
  - e2e

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

# Small job - 2 CPU, 4GB RAM (default)
lint:
  stage: build
  image: golangci/golangci-lint:latest
  script:
    - golangci-lint run ./...
  tags:
    - firecracker-2cpu-4gb

# Standard build job
build:
  stage: build
  image: golang:1.21
  script:
    - go build -o myapp ./cmd/myapp
  artifacts:
    paths:
      - myapp
    expire_in: 1 hour
  tags:
    - firecracker-2cpu-4gb

# Docker build with native Docker (no DIND needed!)
docker-build:
  stage: build
  image: docker:latest
  script:
    - docker build -t myapp:$CI_COMMIT_SHA .
    - docker push myapp:$CI_COMMIT_SHA
  tags:
    - firecracker-4cpu-8gb

# Large job with more resources
test:
  stage: test
  image: golang:1.21
  script:
    - go test -v -race -coverprofile=coverage.out ./...
    - go tool cover -func=coverage.out
  coverage: '/total:\s+\(statements\)\s+(\d+\.\d+)%/'
  tags:
    - firecracker-4cpu-8gb

# Integration test with database
integration:
  stage: test
  image: golang:1.21
  services:
    - postgres:15
    - redis:7
  variables:
    POSTGRES_DB: test_db
    POSTGRES_USER: test_user
    POSTGRES_PASSWORD: test_password
    REDIS_URL: redis://redis:6379
  script:
    - go test -v -tags=integration ./...
  tags:
    - firecracker-4cpu-8gb

# Shell executor example - Full VM access for system-level operations
k8s-e2e:
  stage: e2e
  before_script:
    # Install k3sup for lightweight Kubernetes
    - curl -sLS https://get.k3sup.dev | sh
    - export PATH=$PATH:$HOME/.arkade/bin/
  script:
    # Deploy local Kubernetes cluster
    - mkdir -p ~/.kube/
    - k3sup install --local --local-path ~/.kube/config
    - kubectl get nodes

    # Deploy application
    - kubectl apply -f k8s/
    - kubectl wait --for=condition=ready pod -l app=myapp --timeout=120s

    # Run E2E tests
    - ./run-e2e-tests.sh

    # Cleanup
    - kubectl delete -f k8s/
  tags:
    - firecracker-8cpu-16gb
    - shell  # Uses shell executor instead of docker
  only:
    - main
    - merge_requests

# Android build example (requires system access)
android-build:
  stage: build
  before_script:
    - apt-get update && apt-get install -y openjdk-17-jdk
    - wget https://dl.google.com/android/repository/commandlinetools-linux-latest.zip
    - unzip commandlinetools-linux-latest.zip -d $HOME/android-sdk
  script:
    - ./gradlew assembleRelease
  artifacts:
    paths:
      - app/build/outputs/apk/release/
  tags:
    - firecracker-8cpu-16gb
    - shell

# Performance test with GPU (if supported)
# performance:
#   stage: test
#   script:
#     - ./run-benchmark.sh
#   tags:
#     - firecracker-8cpu-16gb-gpu

# Deploy to production
deploy-production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Deploying to production..."
    - curl -X POST https://api.example.com/deploy \
        -H "Authorization: Bearer $DEPLOY_TOKEN" \
        -d '{"version":"'$CI_COMMIT_SHA'"}'
  tags:
    - firecracker-2cpu-4gb
  only:
    - main
  when: manual

# Multi-stage Docker build example
docker-multistage:
  stage: build
  image: docker:latest
  script:
    - |
      cat > Dockerfile <<EOF
      # Builder stage
      FROM golang:1.21 AS builder
      WORKDIR /app
      COPY . .
      RUN go build -o myapp ./cmd/myapp

      # Final stage
      FROM alpine:latest
      RUN apk add --no-cache ca-certificates
      COPY --from=builder /app/myapp /usr/local/bin/
      CMD ["myapp"]
      EOF
    - docker build -t myapp:latest .
  tags:
    - firecracker-4cpu-8gb

# Parallel test jobs
.test-template: &test-template
  stage: test
  image: golang:1.21
  tags:
    - firecracker-2cpu-4gb

test-unit:
  <<: *test-template
  script:
    - go test -v ./pkg/...

test-api:
  <<: *test-template
  script:
    - go test -v ./api/...

test-integration:
  <<: *test-template
  script:
    - go test -v -tags=integration ./...
  tags:
    - firecracker-4cpu-8gb  # Override for resource-intensive tests
